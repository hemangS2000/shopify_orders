<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    /* Existing styles remain the same */
    .refresh-button {
      margin: 10px 0;
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <button class="refresh-button" onclick="initializeTable()">Refresh Orders</button>
  <table>
    <thead>
      <tr>
        <th>Source</th>
        <th>Order #</th>
        <th>Customer Info</th>
        <th>Items</th>
        <th>Pickup Action</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <!-- Product Image Modal -->
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Product Image</h2>
    <div id="modal-content"></div>
  </div>

  <script>
    // Order Handling
    async function initializeTable() {
      try {
        const response = await fetch('/api/orders');
        const orders = await response.json();
        renderOrders(orders);
      } catch (error) {
        console.error('Failed to load orders:', error);
        alert('Error loading orders');
      }
    }

    function renderOrders(orders) {
      const tbody = document.getElementById('orders-table-body');
      
      tbody.innerHTML = orders.map((order, index) => {
        const requiresShipping = order.line_items.some(item => item.requires_shipping);
        const shippingLine = order.shipping_lines?.[0];
        const isPickupPoint = shippingLine?.title.includes('Pickup');

        return `
          <tr class="${requiresShipping ? '' : 'no-shipping'}">
            <td>${order.source_name}</td>
            <td>
              #${order.order_number}<br>
              <span class="timestamp">${new Date(order.created_at).toLocaleDateString()}</span>
            </td>
            <td>
              ${order.shipping_address?.name || 'N/A'}<br>
              ${order.customer.email}<br>
              ${order.shipping_address?.phone || 'N/A'}
            </td>
            <td class="clickable" onclick="handleItemClick('${order.line_items[0]?.product_id}')">
              ${order.line_items.length}
            </td>
            <td>
              ${isPickupPoint ? `
                <button 
                  class="pickup-btn"
                  data-address='${JSON.stringify(order.shipping_address)}'
                  data-target="pickup-${index}"
                >
                  Find Pickup Point
                </button>
                <div id="pickup-${index}"></div>
              ` : `
                <span class="home-delivery">
                  ${shippingLine?.title || 'No shipping info'}
                </span>
              `}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Pickup Point Handling
    document.addEventListener('click', async (event) => {
      if (event.target.classList.contains('pickup-btn')) {
        const button = event.target;
        const address = JSON.parse(button.dataset.address);
        const targetId = button.dataset.target;
        const container = document.getElementById(targetId);
        
        button.disabled = true;
        container.innerHTML = '<div class="loading">Searching...</div>';

        try {
          const response = await fetch('/api/find-pickup-point', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              streetAddress: address.address1,
              postcode: address.zip,
              locality: address.city,
              countryCode: address.country_code
            })
          });

          const data = await response.json();
          updatePickupPoint(data, targetId);
        } catch (error) {
          container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        } finally {
          button.disabled = false;
        }
      }
    });

    function updatePickupPoint(data, targetId) {
      const container = document.getElementById(targetId);
      const pickupPoint = data.servicePoints?.[0];
      
      if (!pickupPoint) {
        container.innerHTML = '<div class="error">No pickup points found</div>';
        return;
      }

      const address = pickupPoint.addresses?.[0] || {};
      container.innerHTML = `
        <div class="pickup-info">
          <strong>${pickupPoint.pupCode}</strong><br>
          ${address.streetAddress || 'Address not available'}<br>
          ${address.postcode || ''} ${address.city || ''}<br>
          ${address.countryCode || ''}
        </div>
      `;
    }

    // Product Image Modal
    async function handleItemClick(productId) {
      try {
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const productData = await response.json();
        const imageUrl = productData.data?.product?.images?.edges?.[0]?.node?.originalSrc;
        
        document.getElementById('modal-content').innerHTML = imageUrl 
          ? `<img src="${imageUrl}" class="product-image" alt="Product image">`
          : '<p>No image available</p>';
          
        document.getElementById('product-modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
      } catch (error) {
        alert('Error loading product image: ' + error.message);
      }
    }

    function closeModal() {
      document.getElementById('product-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    // Initialization
    initializeTable();
    setInterval(initializeTable, 30000); // Auto-refresh every 30 seconds
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
  </script>
</body>
</html>