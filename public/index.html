<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    /* Existing styles remain the same */
    
    /* Add modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 80%;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <table>
    <thead>
      <tr>
        <th>Source</th>
        <th>Order #</th>
        <th>Customer Info</th>
        <th>Item Count</th>
        <th>Pickup Action</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <!-- Add modal markup -->
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Product Details</h2>
    <div id="modal-content"></div>
  </div>

  <script>
    // Sample orders with product IDs
    const orders = [
      {
        product_id: "gid://shopify/Product/8774958317825",
        source_name: "web",
        order_number: 1001,
        customer: { email: "anna@example.com" },
        shipping_address: {
          name: "Anna Nieminen",
          address1: "Mannerheimintie 10",
          address2: "",
          zip: "00100",
          city: "Helsinki",
          country: "Finland",
          country_code: "FI",
          phone: "+358401234567"
        },
        line_items: [
          { title: "Weber Grill Cover", requires_shipping: true }
        ],
        shipping_lines: [
          { title: "Standard Pickup-Point" }
        ]
      },
      // ... other orders with product_ids ...
    ];

    const tbody = document.getElementById('orders-table-body');

    tbody.innerHTML = orders.map((order, index) => {
      const requiresShipping = order.line_items.some(item => item.requires_shipping);
      const shippingMethod = order.shipping_lines?.[0]?.title || 'No shipping';
      const isPickupPoint = shippingMethod === 'Standard Pickup-Point';
      const rowClass = requiresShipping ? '' : 'no-shipping';

      let pickupActionContent;
      if (!requiresShipping) {
        pickupActionContent = 'Digital product';
      } else if (isPickupPoint) {
        pickupActionContent = `<button onclick='handlePickupClick(${JSON.stringify(order)}, "pickup-${index}")'>Send to API</button>`;
      } else {
        pickupActionContent = `<span class="home-delivery">${shippingMethod}</span>`;
      }

      return `
        <tr class="${rowClass}">
          <td>${order.source_name}</td>
          <td>${order.order_number}</td>
          <td>
            ${order.shipping_address?.name || 'N/A'}<br>
            ${order.customer.email}<br>
            ${order.shipping_address?.phone || 'N/A'}<br>
            ${order.shipping_address ? [
              order.shipping_address.address1,
              order.shipping_address.address2,
              order.shipping_address.zip,
              order.shipping_address.city,
              order.shipping_address.country
            ].filter(Boolean).map(item => `${item}<br>`).join('') : 'No shipping address'}
          </td>
          <td class="clickable" onclick="handleItemCountClick('${order.product_id}')">
            ${order.line_items.length}
          </td>
          <td id="pickup-${index}">
            ${pickupActionContent}
          </td>
        </tr>
      `;
    }).join('');

    // Handle pickup point requests through backend
    async function handlePickupClick(order, elementId) {
      const container = document.getElementById(elementId);
      container.innerHTML = 'Loading...';

      try {
        const response = await fetch('/api/find-pickup-point', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            streetAddress: order.shipping_address?.address1 || '',
            postcode: order.shipping_address?.zip || '',
            locality: order.shipping_address?.city || '',
            countryCode: order.shipping_address?.country_code || 'FI'
          })
        });

        const data = await response.json();
        updatePickupPointUI(data, elementId);
      } catch (err) {
        console.error("API Error:", err);
        container.innerHTML = `Error fetching pickup info.`;
      }
    }

    // Handle product details display
    async function handleItemCountClick(productId) {
      try {
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const productData = await response.json();
        showProductModal(productData);
      } catch (error) {
        console.error('Error fetching product details:', error);
        alert('Failed to load product details');
      }
    }

    // Show modal with product details
    function showProductModal(productData) {
      const product = productData.data?.product;
      const modalContent = document.getElementById('modal-content');
      
      // Extract image URL
      const imageUrl = product?.images?.edges?.[0]?.node?.originalSrc || 'No image available';
      
      // Extract metafield value (replace 'your_metafield_key' with actual key)
      const metafield = product?.metafields?.edges?.find(
        edge => edge.node.key === value
      )?.node?.value || 'No value found';

      modalContent.innerHTML = `
        ${imageUrl.startsWith('http') ? 
          `<img src="${imageUrl}" style="max-width: 300px; margin-bottom: 20px;">` : 
          `<p>${imageUrl}</p>`}
        <h3>Metafield Value:</h3>
        <p>${metafield}</p>
      `;

      document.getElementById('product-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('product-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    // Existing UI update function remains the same
    function updatePickupPointUI(data, elementId) {
      const sp = data?.servicePoints?.[0];
      if (!sp) {
        document.getElementById(elementId).innerHTML = `No pickup point found.`;
        return;
      }

      const address = sp.addresses?.[0];
      const details = {
        pupCode: sp.pupCode,
        streetAddress: address?.streetAddress || '',
        postcode: address?.postcode || '',
        city: address?.city || '',
        countryCode: address?.countryCode || ''
      };

      document.getElementById(elementId).innerHTML = `
        <strong>${details.pupCode}</strong><br>
        ${details.streetAddress}<br>
        ${details.postcode} ${details.city}<br>
        ${details.countryCode}
      `;
    }

    // Close modal when clicking overlay
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
  </script>
</body>
</html>