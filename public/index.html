<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    /* Table Styles */
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    .no-shipping { background-color: #ffdddd; }
    .home-delivery { color: #666; font-style: italic; }
    
    /* Interactive Elements */
    .clickable { cursor: pointer; color: #007bff; }
    button { 
      padding: 6px 12px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #cccccc; }

    /* Modal Styles */
    .modal { 
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 80%;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .product-image {
      max-width: 300px;
      height: auto;
      margin-bottom: 10px;
    }

    /* Status Messages */
    .loading { color: #666; font-style: italic; }
    .error { color: #dc3545; font-weight: bold; }
    .pickup-info { background: #f8f9fa; padding: 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <table>
    <thead>
      <tr>
        <th>Source</th>
        <th>Order #</th>
        <th>Customer Info</th>
        <th>Items</th>
        <th>Pickup Action</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <!-- Product Image Modal -->
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Product Image</h2>
    <div id="modal-content"></div>
  </div>

  <script>
    // Sample Orders Data
    const orders = [
      {
        product_id: "gid://shopify/Product/8774958317825",
        source_name: "web",
        order_number: 1001,
        customer: { email: "anna@example.com" },
        shipping_address: {
          name: "Anna Nieminen",
          address1: "Mannerheimintie 10",
          zip: "00100",
          city: "Helsinki",
          country_code: "FI"
        },
        line_items: [
          { title: "Weber Grill Cover", requires_shipping: true }
        ],
        shipping_lines: [
          { title: "Standard Pickup-Point" }
        ]
      }
    ];

    // Initialize Table
    function initializeTable() {
      const tbody = document.getElementById('orders-table-body');
      
      tbody.innerHTML = orders.map((order, index) => {
        const requiresShipping = order.line_items.some(i => i.requires_shipping);
        const shippingMethod = order.shipping_lines?.[0]?.title || 'No shipping';
        const isPickupPoint = shippingMethod === 'Standard Pickup-Point';

        return `
          <tr class="${requiresShipping ? '' : 'no-shipping'}">
            <td>${order.source_name}</td>
            <td>${order.order_number}</td>
            <td>
              ${order.shipping_address?.name || 'N/A'}<br>
              ${order.customer.email}<br>
              ${order.shipping_address?.address1 || ''}, 
              ${order.shipping_address?.zip || ''} 
              ${order.shipping_address?.city || ''}
            </td>
            <td class="clickable" onclick="handleItemClick('${order.product_id}')">
              ${order.line_items.length}
            </td>
            <td>
              ${isPickupPoint ? `
                <button 
                  class="pickup-btn"
                  data-address='${JSON.stringify(order.shipping_address)}'
                  data-target="pickup-${index}"
                >
                  Find Pickup Point
                </button>
                <div id="pickup-${index}"></div>
              ` : `<span class="home-delivery">${shippingMethod}</span>`}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Handle Pickup Point Requests
    document.addEventListener('click', async (event) => {
      if (event.target.classList.contains('pickup-btn')) {
        const button = event.target;
        const address = JSON.parse(button.dataset.address);
        const targetId = button.dataset.target;
        const container = document.getElementById(targetId);
        
        button.disabled = true;
        container.innerHTML = '<div class="loading">Searching...</div>';

        try {
          const response = await fetch('/api/find-pickup-point', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              streetAddress: address.address1,
              postcode: address.zip,
              locality: address.city,
              countryCode: address.country_code
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          updatePickupPoint(data, targetId);
          
        } catch (error) {
          console.error('Pickup Error:', error);
          container.innerHTML = `<div class="error">${error.message}</div>`;
        } finally {
          button.disabled = false;
        }
      }
    });

    // Update Pickup Point Display
    function updatePickupPoint(data, targetId) {
      const container = document.getElementById(targetId);
      const sp = data.servicePoints?.[0];
      
      if (!sp) {
        container.innerHTML = '<div class="error">No pickup points found</div>';
        return;
      }

      const address = sp.addresses?.[0] || {};
      container.innerHTML = `
        <div class="pickup-info">
          <strong>${sp.pupCode}</strong><br>
          ${address.streetAddress || 'Address not available'}<br>
          ${address.postcode || ''} ${address.city || ''}<br>
          ${address.countryCode || ''}
        </div>
      `;
    }

    // Product Image Modal
    async function handleItemClick(productId) {
      try {
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const data = await response.json();
        const imageUrl = data.data?.product?.images?.edges?.[0]?.node?.originalSrc;
        
        document.getElementById('modal-content').innerHTML = imageUrl 
          ? `<img src="${imageUrl}" class="product-image">`
          : '<p>No image available</p>';
          
        document.getElementById('product-modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
      } catch (error) {
        alert('Error loading image: ' + error.message);
      }
    }

    function closeModal() {
      document.getElementById('product-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    // Initialize
    initializeTable();
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
  </script>
</body>
</html>