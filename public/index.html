<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    /* Table Styles */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; }
    tr:hover { background-color: #f1f1f1; }
    
    /* Interactive Elements */
    .clickable { cursor: pointer; color: #007bff; }
    button { 
      padding: 8px 16px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #6c757d; cursor: not-allowed; }
    
    /* Modal Styles */
    .modal { 
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* Image Styles */
    .product-image {
      max-width: 100%;
      height: auto;
      max-height: 70vh;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }
    .image-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    
    /* Status Messages */
    .loading { color: #6c757d; font-style: italic; }
    .error { color: #dc3545; font-weight: bold; padding: 1rem; }
    .warning { color: #ffc107; padding: 1rem; }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <button onclick="refreshOrders()" class="refresh-btn">Refresh Orders</button>
  <table>
    <thead>
      <tr>
        <th>Order #</th>
        <th>Customer</th>
        <th>Items</th>
        <th>Shipping</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <!-- Product Images Modal -->
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2 id="modal-title">Product Images</h2>
    <div id="modal-content" class="image-container"></div>
  </div>

  <script>
    // Order Handling
    async function refreshOrders() {
      try {
        const response = await fetch('/api/orders');
        const orders = await response.json();
        renderOrders(orders);
      } catch (error) {
        showError('Failed to refresh orders: ' + error.message);
      }
    }

    function renderOrders(orders) {
      const tbody = document.getElementById('orders-table-body');
      tbody.innerHTML = orders.map((order, index) => {
        const mainProduct = order.line_items[0];
        const shippingMethod = order.shipping_lines[0]?.title;
        const isPickup = shippingMethod?.includes('Pickup');

        return `
          <tr>
            <td>#${order.order_number}</td>
            <td>
              ${order.shipping_address?.name || 'N/A'}<br>
              ${order.shipping_address?.phone || ''}
            </td>
            <td class="clickable" onclick="showProductImages('${mainProduct.product_id}')">
              ${order.line_items.length} items
            </td>
            <td>${shippingMethod || 'Standard Shipping'}</td>
            <td>
              ${isPickup ? `
                <button 
                  onclick="findPickupPoint('${index}')"
                  data-address='${JSON.stringify(order.shipping_address)}'
                >
                  Find Pickup
                </button>
                <div id="pickup-${index}"></div>
              ` : 'Home Delivery'}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Product Images
    async function showProductImages(productId) {
      try {
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const data = await response.json();
        const product = data.data?.product;
        
        let imagesHTML = '';
        if (product?.featuredImage?.originalSrc) {
          imagesHTML = createImageCard(product.featuredImage.originalSrc);
        }
        
        if (product?.images?.edges?.length) {
          imagesHTML += product.images.edges
            .filter(img => img.node.originalSrc !== product.featuredImage?.originalSrc)
            .map(img => createImageCard(img.node.originalSrc))
            .join('');
        }

        document.getElementById('modal-content').innerHTML = imagesHTML || 
          '<div class="warning">No images available</div>';
        
        document.getElementById('modal-title').textContent = product?.title || 'Product Images';
        showModal();
      } catch (error) {
        showError('Error loading product: ' + error.message);
      }
    }

    function createImageCard(src) {
      return `
        <div class="image-card">
          <img 
            src="${src}" 
            class="product-image"
            onerror="handleImageError(this)"
            alt="Product image"
          >
        </div>
      `;
    }

    function handleImageError(img) {
      img.style.display = 'none';
      const card = img.parentElement;
      card.innerHTML = '<div class="error">Failed to load image</div>';
    }

    // Pickup Point Handling
    async function findPickupPoint(index) {
      const container = document.getElementById(`pickup-${index}`);
      const button = event.target;
      const address = JSON.parse(button.dataset.address);
      
      try {
        button.disabled = true;
        container.innerHTML = '<div class="loading">Searching...</div>';

        const response = await fetch('/api/find-pickup-point', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            streetAddress: address.address1,
            postcode: address.zip,
            locality: address.city,
            countryCode: address.country_code
          })
        });

        const data = await response.json();
        container.innerHTML = formatPickupInfo(data);
      } catch (error) {
        container.innerHTML = `<div class="error">${error.message}</div>`;
      } finally {
        button.disabled = false;
      }
    }

    function formatPickupInfo(data) {
      const point = data.servicePoints?.[0];
      if (!point) return '<div class="warning">No pickup points found</div>';

      const address = point.addresses?.[0] || {};
      return `
        <div class="pickup-info">
          <strong>${point.pupCode}</strong><br>
          ${address.streetAddress || ''}<br>
          ${address.postcode || ''} ${address.city || ''}<br>
          ${address.countryCode || ''}
        </div>
      `;
    }

    // Modal Control
    function showModal() {
      document.getElementById('product-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('product-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    // Error Handling
    function showError(message) {
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = `<div class="error">${message}</div>`;
      showModal();
    }

    // Initialization
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
    refreshOrders();
    setInterval(refreshOrders, 30000);
  </script>
</body>
</html>