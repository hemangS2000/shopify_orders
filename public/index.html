<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    :root {
      --primary-color: #007bff;
      --error-color: #dc3545;
      --success-color: #28a745;
      --bg-color: rgba(255, 255, 255, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.2);
      --blur-strength: 8px;
      --text-color: #333; /* Added for better readability */
      --border-color: rgba(0, 0, 0, 0.1); /* Added for better contrast */
    }
  
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 123, 255, 0.2));
      padding: 20px;
      color: var(--text-color); /* Updated for better readability */
    }
  
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: white; /* Changed to solid for better readability */
      border-radius: 10px;
    }
  
    th, td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
    }
  
    th {
      background-color: #f8f9fa; /* Solid background for header */
      font-weight: 600;
      color: var(--text-color);
    }
  
    tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
  
    .clickable {
      cursor: pointer;
      color: var(--primary-color);
      text-decoration: underline;
      transition: color 0.3s ease;
    }
  
    .clickable:hover {
      color: #0056b3;
    }
  
    button {
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
  
    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
  
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 999;
    }
  
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
  
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
      color: var(--text-color);
    }
  
    .image-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
  
    .product-image {
      width: 100%;
      height: auto;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 4px;
      background: white;
      transition: transform 0.3s ease;
    }
  
    .product-image:hover {
      transform: scale(1.05);
    }
  
    .error-message {
      color: var(--error-color);
      padding: 1rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
    }
  
    .loading {
      padding: 1rem;
      text-align: center;
      color: #666;
    }
    
    /* New styles for dimensions inputs */
    .dimensions-input {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .dimensions-input input {
      width: 40px;
      text-align: center;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .weight-input {
      width: 60px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
    }
    
    .shipping-method-select {
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 100%;
    }
    .product-section {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .product-section h3 {
      margin: 0 0 1rem 0;
      color: var(--primary-color);
    }

    .product-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .box-input {
      width: 40px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
    }
  
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <button onclick="refreshOrders()">Refresh Orders</button>
  
  <table>
    <thead>
      <tr>
        <th>Order #</th>
        <th>Shipping Address</th>
        <th>Items</th>
        <th>Measurements</th>
        <th>Shipping Method</th>
        <th>Choose Service</th>
        <th>Actions</th>
        <th>Create Shipment</th>
        <th>Fulfill</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2 id="modal-title">Product Images</h2>
    <div class="image-container" id="modal-content"></div>
  </div>

  <script>
    let currentOrders = [];

    async function refreshOrders() {
          try {
            // Save current input values before refresh
            const inputsToSave = {};
            currentOrders.forEach((order, index) => {
              if (!order.shopifyId) return;
              
              inputsToSave[order.shopifyId] = {
                length: document.getElementById(`length-${index}`)?.value,
                width: document.getElementById(`width-${index}`)?.value,
                height: document.getElementById(`height-${index}`)?.value,
                weight: document.getElementById(`weight-${index}`)?.value,
                boxes: document.getElementById(`boxes-${index}`)?.value,
                method: document.getElementById(`method-${index}`)?.value
              };
            });

            const response = await fetch('/api/orders');
            currentOrders = await response.json();
            renderOrders();

            // Restore input values after refresh
            currentOrders.forEach((order, index) => {
              if (!order.shopifyId || !inputsToSave[order.shopifyId]) return;
              
              const saved = inputsToSave[order.shopifyId];
              if (saved.length) document.getElementById(`length-${index}`).value = saved.length;
              if (saved.width) document.getElementById(`width-${index}`).value = saved.width;
              if (saved.height) document.getElementById(`height-${index}`).value = saved.height;
              if (saved.weight) document.getElementById(`weight-${index}`).value = saved.weight;
              if (saved.boxes) document.getElementById(`boxes-${index}`).value = saved.boxes;
              if (saved.method) document.getElementById(`method-${index}`).value = saved.method;
            });
          } catch (error) {
            showError('Failed to refresh orders: ' + error.message);
          }
        }

    function renderOrders() {
      const tbody = document.getElementById('orders-table-body');
      tbody.innerHTML = currentOrders.map((order, index) => {
        const mainItem = order.line_items[0];
        const shipping = order.shipping_lines[0];
        const address = order.shipping_address;

        return `
          <tr>
            <td>#${order.orderNumber}</td>
            <td>
              ${address.name || ''}<br>
              ${address.address1 || ''}<br>
              ${address.address2 ? `${address.address2}<br>` : ''}
              ${address.zip || ''}, ${address.city || ''}<br>
              ${address.country_code || ''}
            </td>
            <td class="clickable" onclick="showProductImages(${index})">
              ${order.line_items.map(item => `
                ${item.quantity}x ${item.product_data?.metafield?.value || item.title}<br>
              `).join('')}
            </td>
            <td>
              <div class="measurements-column">
                <!-- First line: L×W×H -->
                <div class="dimensions-input">
                  <input type="number" min="1" max="999" placeholder="L" 
                        id="length-${index}" value="${order.dimensions?.length || ''}"
                        onchange="saveMeasurements('${order.shopifyId}', ${index})">
                  <span>x</span>
                  <input type="number" min="1" max="999" placeholder="W" 
                        id="width-${index}" value="${order.dimensions?.width || ''}"
                        onchange="saveMeasurements('${order.shopifyId}', ${index})">
                  <span>x</span>
                  <input type="number" min="1" max="999" placeholder="H" 
                        id="height-${index}" value="${order.dimensions?.height || ''}"
                        onchange="saveMeasurements('${order.shopifyId}', ${index})">
                </div>

                <!-- Second line: weight and box count -->
                <div class="dimensions-input" style="margin-top:0.5rem;">
                  Weight: <input type="number" min="0.1" max="99" step="0.1" placeholder="kg" 
                        class="weight-input" id="weight-${index}"
                        value="${order.dimensions?.weight || ''}"
                        onchange="saveMeasurements('${order.shopifyId}', ${index})">
                  <span> Boxes: </span>
                  <input type="number" min="1" max="99" placeholder="#" 
                        class="box-input" id="boxes-${index}"
                        value="${order.dimensions?.boxes || ''}"
                        onchange="saveMeasurements('${order.shopifyId}', ${index})">
                </div>
              </div>
            </td>
            <td>${shipping?.title || 'Standard Shipping'}</td>
            <td>
              <select class="shipping-method-select" id="method-${index}">
                <option value="service_point">Posti Service Point</option>
                <option value="home_delivery">Posti Home Delivery</option>
              </select>
            </td>
            <td>
              ${document.getElementById(`method-${index}`)?.value === 'service_point' ? `
                ${!order.pickupPoint ? `
                  <button id="findPickup-${index}" onclick="handlePickup(${index})">
                    Find Pickup
                  </button>
                ` : ''}
                <div id="pickup-${index}">
                  ${order.pickupPoint ? `
                    <div style="margin-top: 5px; font-size: 0.9em;">
                      <strong>${order.pickupPoint.publicName || ''}</strong><br>
                      ${order.pickupPoint.streetAddress || ''}<br>
                      ${order.pickupPoint.postcode || ''} ${order.pickupPoint.city || ''}<br>
                      ${order.pickupPoint.parcelLocker ? 'Parcel Locker' : 'Post Office'}<br>
                      <b>Distance:</b> ${order.pickupPoint.distance}
                    </div>
                  ` : ''}
                </div>
              ` : 'Home Delivery'}
            </td>
            <td>
            <button onclick="createPostiShipment(${index})" style="margin-bottom: 5px;">
              Create Posti Order
            </button>
            <td>
              <button onclick="fulfillOrder('${order.shopifyId}')">
                Fulfill Order
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }


    async function saveMeasurements(orderId, index) {
      const dimensions = {
        length: Number(document.getElementById(`length-${index}`).value),
        width: Number(document.getElementById(`width-${index}`).value),
        height: Number(document.getElementById(`height-${index}`).value),
        weight: Number(document.getElementById(`weight-${index}`).value),
        boxes: Number(document.getElementById(`boxes-${index}`).value)
      };

      try {
        const response = await fetch('/api/update-measurements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            orderId: orderId,
            dimensions 
          })
        });
        
        if (!response.ok) throw new Error('Failed to save');
      } catch (err) {
        console.error('Save failed:', err);
        alert('Failed to save measurements. Please try again.');
      }
    }



    async function showProductImages(orderIndex) {
      try {
        const order = currentOrders[orderIndex];
        document.getElementById('modal-content').innerHTML = '<div class="loading">Loading product details...</div>';
        showModal();

        // Get the pre-fetched product data
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId: order.shopifyId })  // Use shopifyId instead of id
        });

        const data = await response.json();
        let imagesHTML = '';

        // Changed from data.data.order.line_items to data.data.line_items
        data.data.line_items.forEach(item => {
          const product = item.product_data;
          if (product) {
            imagesHTML += `
              <div class="product-section">
                <h3>${product.title} (Qty: ${item.quantity})</h3>
                ${product.metafield?.value ? `<p>${product.metafield.value}</p>` : ''}
                <div class="product-images">
                  ${product.images.edges.map(img => `
                    <img src="${img.node.originalSrc}" 
                        class="product-image"
                        onerror="this.remove()"
                        alt="${product.title}">
                  `).join('')}
                </div>
              </div>
            `;
          }
        });

        document.getElementById('modal-content').innerHTML = imagesHTML || 
          '<div class="error-message">No product images available</div>';
        
        document.getElementById('modal-title').textContent = `Order #${order.orderNumber} Products`;
      } catch (error) {
        document.getElementById('modal-content').innerHTML = `
          <div class="error-message">Error: ${error.message}</div>
        `;
      }
    }

  async function handlePickup(index) {

    if (document.getElementById(`method-${index}`).value !== 'service_point') {
    return;
  }

  document.getElementById(`findPickup-${index}`).style.display = 'none';
  const order = currentOrders[index];
  const container = document.getElementById(`pickup-${index}`);

  try {
    container.innerHTML = '<div class="loading">Searching pickup points...</div>';

    const response = await fetch('/api/find-pickup-point', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        streetAddress: order.shipping_address.address1,
        postcode: order.shipping_address.zip,
        locality: order.shipping_address.city,
        countryCode: order.shipping_address.country_code
      })
    });

    const data = await response.json();
    const points = data.servicePoints || [];

    if (points.length) {
      points.sort((a, b) => a.distanceInMeters - b.distanceInMeters);
      const closestPoint = points[0];

      let distanceText = '';
      if (closestPoint.distanceInMeters >= 1000) {
        distanceText = `${(closestPoint.distanceInMeters / 1000).toFixed(1)} km`;
      } else {
        distanceText = `${closestPoint.distanceInMeters} m`;
      }

      // Prepare pickup point data for saving
      const pickupPointData = {
        pupCode: closestPoint.pupCode,
        publicName: closestPoint.addresses?.[0]?.publicName || 'No public name available',
        streetAddress: closestPoint.addresses?.[0]?.streetAddress || '',
        postcode: closestPoint.addresses?.[0]?.postcode || '',
        city: closestPoint.addresses?.[0]?.city || '',
        countryCode: closestPoint.addresses?.[0]?.countryCode || '',
        parcelLocker: closestPoint.parcelLocker || false,
        distance: distanceText,
      };

      // Save to database
      await fetch('/api/update-pickup-point', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          orderId: order.shopifyId,
          pickupPoint: pickupPointData
        })
      });

      container.innerHTML = `
        <div style="margin-top: 5px; font-size: 0.9em;">
          <strong>${pickupPointData.publicName}</strong><br>
          ${pickupPointData.streetAddress}<br>
          ${pickupPointData.postcode} ${pickupPointData.city}<br>
          ${pickupPointData.countryCode}<br>
          ${pickupPointData.parcelLocker ? 'Parcel Locker' : 'Post Office'}<br>
          <b>Distance:</b> ${pickupPointData.distance}
        </div>
      `;
    } else {
      container.innerHTML = '<div class="error-message">No pickup points found</div>';
    }
  } catch (error) {
    container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
  }
}

    function showModal() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('product-modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = 'none';
      document.getElementById('product-modal').style.display = 'none';
    }

    function showError(message) {
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = `<div class="error-message">${message}</div>`;
      showModal();
    }


async function createPostiShipment(index) {
  try {
    const order = currentOrders[index];
    const country = order.shipping_address.country_code;
    const methodSelect = document.getElementById(`method-${index}`);
    const selectedMethod = methodSelect.value;
    
    // Check if country is Finland
    if (!country || country.toUpperCase() !== 'FI') {
      throw new Error('Posti shipments only available for Finland');
    }
    
    // Get dimensions
    const dimensions = {
      length: Number(document.getElementById(`length-${index}`).value),
      width: Number(document.getElementById(`width-${index}`).value),
      height: Number(document.getElementById(`height-${index}`).value),
      weight: Number(document.getElementById(`weight-${index}`).value),
      boxes: Number(document.getElementById(`boxes-${index}`).value)
    };
    
    // Validate dimensions
    if (!dimensions.weight || !dimensions.boxes) {
      throw new Error('Please enter weight and box count');
    }
    
    // Determine which endpoint to call based on selected method
    const endpoint = selectedMethod === 'service_point' 
      ? '/api/create-posti-service-point' 
      : '/api/create-posti-home-delivery';
    
    // Create Posti shipment
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId: order.shopifyId,
        dimensions,
        orderData: order
      })
    });
    
    const data = await response.json();
    if (data.success) {
      alert('Posti order created successfully!');
      console.log('Posti response:', data.data);
    } else {
      throw new Error(data.error || 'Failed to create Posti order');
    }
  } catch (err) {
    console.error('Error creating Posti order:', err);
    alert('Error creating Posti order: ' + err.message);
  }
}



  async function fulfillOrder(orderId) {
  if (!confirm('Are you sure you want to fulfill this order?')) return;

  try {
    const response = await fetch('/api/fulfill-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId: orderId
      })
    });

    const data = await response.json();
    if (data.success) {
      alert('Order fulfilled successfully!');
    } else {
      console.error(data.error);
      alert('Failed to fulfill order.');
    }
  } catch (err) {
    console.error('Error fulfilling order:', err);
    alert('Error fulfilling order: ' + err.message);
  }
}

document.addEventListener('change', function(e) {
  if (e.target.classList.contains('shipping-method-select')) {
    const index = e.target.id.split('-')[1];
    renderOrders(); // Re-render the row when selection changes
  }
});

    // Initialization
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
    refreshOrders();
    setInterval(refreshOrders, 30000);
  </script>
</body>
</html>