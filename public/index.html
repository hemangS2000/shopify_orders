<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    button { 
      padding: 6px 12px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    .no-shipping { background-color: #ffdddd; }
    .home-delivery { color: #666; font-style: italic; }
    .clickable { cursor: pointer; text-decoration: underline; color: #007bff; }
    
    /* Modal Styles */
    .modal { 
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 80%;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .product-image {
      max-width: 300px;
      height: auto;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <table>
    <thead>
      <tr>
        <th>Source</th>
        <th>Order #</th>
        <th>Customer Info</th>
        <th>Items</th>
        <th>Pickup Action</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <!-- Product Image Modal -->
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal" id="product-modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Product Image</h2>
    <div id="modal-content"></div>
  </div>

  <script>
    // Sample Orders Data - REPLACE WITH REAL PRODUCT IDs
    const orders = [
      {
        product_id: "gid://shopify/Product/8774958317825",
        source_name: "web",
        order_number: 1001,
        customer: { email: "anna@example.com" },
        shipping_address: {
          name: "Anna Nieminen",
          address1: "Mannerheimintie 10",
          zip: "00100",
          city: "Helsinki",
          country: "Finland"
        },
        line_items: [
          { title: "Weber Grill Cover", requires_shipping: true }
        ],
        shipping_lines: [
          { title: "Standard Pickup-Point" }
        ]
      },
      // Add more orders...
    ];

    // Initialize Orders Table
    function initializeTable() {
      const tbody = document.getElementById('orders-table-body');
      
      tbody.innerHTML = orders.map((order, index) => {
        const requiresShipping = order.line_items.some(i => i.requires_shipping);
        const shippingMethod = order.shipping_lines?.[0]?.title || 'No shipping';
        const isPickupPoint = shippingMethod === 'Standard Pickup-Point';
        const rowClass = requiresShipping ? '' : 'no-shipping';

        let pickupActionContent;
        if (!requiresShipping) {
          pickupActionContent = 'Digital product';
        } else if (isPickupPoint) {
          pickupActionContent = `<button onclick="handlePickupClick(${JSON.stringify(order)}, 'pickup-${index}')">Find Pickup Point</button>`;
        } else {
          pickupActionContent = `<span class="home-delivery">${shippingMethod}</span>`;
        }

        return `
          <tr class="${rowClass}">
            <td>${order.source_name}</td>
            <td>${order.order_number}</td>
            <td>
              ${order.shipping_address?.name || 'N/A'}<br>
              ${order.customer.email}<br>
              ${order.shipping_address?.phone || 'N/A'}
            </td>
            <td class="clickable" onclick="handleItemClick('${order.product_id}')">
              ${order.line_items.length}
            </td>
            <td id="pickup-${index}">
              ${pickupActionContent}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Handle Item Click (Product Image)
    async function handleItemClick(productId) {
      try {
        const response = await fetch('/api/get-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const productData = await response.json();
        showProductModal(productData);
      } catch (error) {
        alert('Error loading product image: ' + error.message);
      }
    }

    // Show Product Image Modal
    function showProductModal(data) {
      const imageUrl = data.data?.product?.images?.edges?.[0]?.node?.originalSrc;
      const modalContent = document.getElementById('modal-content');
      
      modalContent.innerHTML = imageUrl 
        ? `<img src="${imageUrl}" class="product-image" alt="Product image">`
        : '<p>No image available</p>';

      document.getElementById('product-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
    }

    // Handle Pickup Point Request
    async function handlePickupClick(order, elementId) {
      const container = document.getElementById(elementId);
      container.innerHTML = 'Searching...';

      try {
        const response = await fetch('/api/find-pickup-point', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            streetAddress: order.shipping_address?.address1 || '',
            postcode: order.shipping_address?.zip || '',
            locality: order.shipping_address?.city || '',
            countryCode: order.shipping_address?.country_code || 'FI'
          })
        });

        const data = await response.json();
        updatePickupInfo(data, elementId);
      } catch (error) {
        container.innerHTML = 'Error finding pickup point';
      }
    }

    // Update Pickup Point Display
    function updatePickupInfo(data, elementId) {
      const sp = data.servicePoints?.[0];
      const container = document.getElementById(elementId);
      
      if (!sp) {
        container.innerHTML = 'No pickup points found';
        return;
      }

      const address = sp.addresses?.[0] || {};
      container.innerHTML = `
        <strong>${sp.pupCode}</strong><br>
        ${address.streetAddress || ''}<br>
        ${address.postcode || ''} ${address.city || ''}<br>
        ${address.countryCode || ''}
      `;
    }

    // Close Modal
    function closeModal() {
      document.getElementById('product-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }

    // Initialize on Load
    initializeTable();
    document.getElementById('modal-overlay').addEventListener('click', closeModal);
  </script>
</body>
</html>